# üëÄ Summary

Snitch World is a re-imagining of a previous project (now deprecated).  This iteration of Snitch has been updated to showcase some use some of the new features and services from Mux.  Snitch demonstrates how to create an experience that was interactive with elements that demonstrated moments where commerce and **Viewer** interactions could take place.

Snitch has 2 _main_ pages:

- Studio - Used by the **Content Creator** persona to go live from the browser
- Watch - Used by the **Viewer** persona to view a live stream

**NOTE**: This repo is provided purely for educational purposes and offers no formal support.

## ‚ú® Features

- [Mux Spaces](https://docs.mux.com/guides/video/build-real-time-video-experiences): Used on the Studio page and that allows the **Content Creator** to go live from the browser.
- [Mux Livestream Low Latency](https://docs.mux.com/guides/video/reduce-live-stream-latency): The livestream that Studio Embed uses is configured by Snitch to use the low latency feature.
- [Mux Player](https://docs.mux.com/guides/video/mux-player): Used on the Watch page.  Contains custom media elements for reactions, reaction presentation and call to action.  This is only rendered for the **Viewer** via the watch page.
- Reactions: Allows **Viewers** to react to the live stream as it is occurring in order to let other **Viewers** and **Content Creator** know their sentiments of the live stream.
- Call to Actions: The **Content Creator** has the ability to publish a Call to Action to **Viewers** with a link that displays over the player during a live stream.
- [Mux Engagement Stat Counts](https://docs.mux.com/guides/data/see-how-many-people-are-watching): Displayed on the Studio page so that the **Content Creator** can see it.
- PubNub Integration: Uses PubNub's event message bus for publishing and subscribing messages between Watch page, Watch page and Snitch backend middleware.

## üéÅ Installation

This project is intended to be deployed on Vercel and used with Okta for authenticating Content Creators to ensure that they are authorized to use Snitch for demo purposes.

## üéõÔ∏è Environment variables

Environment variables should be created within Vercel underneath the "Settings" > "Environment Variables" section for the project.  These values will need to be configured in order to use Snitch.

### `NEXT_PUBLIC_MUX_STREAM_BASE_URL`

**Recommended value**: `https://stream.mux.com`

The `NEXT_PUBLIC_MUX_STREAM_BASE_URL` environment variable is the base url that is used to [delivering the Mux live stream](https://docs.mux.com/guides/video/play-your-videos#2-create-an-hls-url).  Default base url value for Mux customers would be to use `https://stream.mux.com`.

In cases where the Mux's custom domains feature is being used, this would be set to an applicable value.

### `NEXT_PUBLIC_MUX_LITIX_DOMAIN`

**Recommended value**: `img.litix.io`

The `NEXT_PUBLIC_MUX_LITIX_DOMAIN` is the domain for which [Mux Data](https://docs.mux.com/guides/data) beacons will be sent to.  Used only for capturing anonymized QoE (Quality of Experience) telemetry.

### `NEXT_PUBLIC_MUX_ENV_KEY`

The `NEXT_PUBLIC_MUX_ENV_KEY` is used with the Mux Data SDK to correlate the data beacons to a specific Mux Account.

To obtain this value, log into the [Mux Dashboard](https://dashboard.mux.com/environments) and grab the "Env Key" value for the desired Mux environment.

### `MUX_API_BASE_URL`

**Recommended value**: `https://api.mux.com`

The `MUX_API_BASE_URL` environment variable is the base url for [Mux's APIs](https://docs.mux.com/api-reference/video).  This should not need to change.

### `MUX_STATS_BASE_URL`

**Recommended value**: `https://stats.mux.com`

The `MUX_API_BASE_URL` environment variable is the base url for [Mux's Real-Time Engagement Counts API](https://docs.mux.com/guides/data/see-how-many-people-are-watching).  This should not need to change.

### `MUX_ACCESS_TOKEN_ID` and `MUX_SECRET_KEY`

In order for Snitch to work, an Access Token set will need to be generated and scoped for **Mux Video, Read + Write** operations.  for your Mux environment.

Please see our [Access token permissions
](https://docs.mux.com/guides/video/make-api-requests#access-token-permissions) documentation for details on creating this set.

### `MUX_WEBHOOK_SIGNING_SECRET`

Events generated by Mux for live streams are sent to a webhook handler for Snitch.  The `MUX_WEBHOOK_SIGNING_SECRET` is used to validate the signature on the webhook events.

To set up your webhook, follow the [Configuring endpoints](https://docs.mux.com/guides/video/listen-for-webhooks#configuring-endpoints) documentation and point your webhook to your instance of Snitch at the `/mux-webhook-handler` route.  The Signing key value is what is used for this environment variable.

### `MUX_VIDEO_SIGNING_KEY` and `MUX_VIDEO_SIGNING_PRIVATE_KEY`

Used by Snitch for setting up Mux Studio session for content creator.  

To generate a new key set, navigate to the Mux Dashboard and click "Settings" > "Signing Keys".  On the Signing Keys view, click the "Generate new key" button.  Select the "Video" product and click the "Generate Signing Key" button to create a new key set.

### `MUX_DATA_SIGNING_KEY` and `MUX_DATA_SIGNING_PRIVATE_KEY`

Used by Snitch for retrieving watcher count from Mux.

To generate a new key set, navigate to the Mux Dashboard and click "Settings" > "Signing Keys".  On the Signing Keys view, click the "Generate new key" button.  Select the "Data" product and click the "Generate Signing Key" button to create a new key set.

### `NEXT_PUBLIC_PUBNUB_PUBLISH_KEY`, `NEXT_PUBLIC_PUBNUB_SUBSCRIBER_KEY` and `PUBNUB_SECRET_KEY`

These values can be obtained by logging into PubNub's Dashboard and selecting the "Keyset" menu item.

### `OKTA_CLIENT_ID`, `OKTA_ISSUER` and `OKTA_CLIENT_SECRET`

Acquired from within Okta when setting up a new App and used to authenticate content creators.

### `NEXTAUTH_SECRET`

Acquired by generating a random string which is used to hash tokens.

Follow the instructions defined on [NextAuth.js's documentation](https://next-auth.js.org/configuration/options#secret) for generating a value.

The only recommended difference would be to generate a random hex string with the `-hex` modifier‚Äî 

```sh
% openssl rand -hex 32
```

## ‚ùì FAQ

### Getting "The engine "node" is incompatible with this module." when deploying to Vercel

If while you're deploying to Vercel, you get an error similar to the following‚Äî

```
The engine "node" is incompatible with this module. Expected version "^12.19.0 || ^14.15.0 || ^16.13.0"
```

This can be fixed by going into the Settings of your project and changing the "Node.js Version" setting to `16.x`.  Once this is done, you can attempt a Redploy for the project.

### Can I disable the Okta integration?

You _can_ disable Okta authentication for the Studio page.  However, it is **highly** recommended to keep it enabled or to have another method for protecting the `/studio` page from being accessed from the general public (which in turn will have a cost of goods implication).  To disable Okta, set the `OKTA_ENABLE` environment variable to `false`.
